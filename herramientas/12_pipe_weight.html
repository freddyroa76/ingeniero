<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pipe Weight Calculator – ASME B36.10M</title>
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Professional Compiled CSS -->
    <link rel="stylesheet" href="../dist/output.css" />
    <script src="js/common.js"></script>
    <style>
      .editable {
        text-decoration: underline;
        text-decoration-style: dotted;
        cursor: pointer;
      }
      .editable:focus {
        outline: 2px solid var(--primary);
        background: rgba(26, 115, 232, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-50 uppercase-labels">
    <!-- Header -->
    <header
      class="fixed top-0 left-0 right-0 z-50 bg-[#006097] shadow-lg border-b border-[#005080]"
    >
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <div class="flex-shrink-0">
            <a
              href="../index.html"
              class="text-2xl font-extrabold text-white hover:opacity-90 transition-opacity"
            >
              Freddy Roa M.
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-baseline space-x-4">
            <a
              href="../index.html"
              class="text-white hover:opacity-80 px-3 py-2 rounded-md text-sm font-medium transition-colors relative group"
            >
              Inicio
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>

            <!-- Herramientas Dropdown -->
            <div class="relative group">
              <a
                href="../herramientas.html"
                class="text-white px-3 py-2 rounded-md text-sm font-bold transition-colors relative flex items-center gap-1 group-link"
              >
                Herramientas
                <svg
                  class="w-4 h-4 fill-current transition-transform group-hover:rotate-180"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                  />
                </svg>
                <span
                  class="absolute bottom-0 left-0 w-full h-0.5 bg-white transition-all duration-300"
                ></span>
              </a>

              <!-- Dropdown Menu -->
              <div
                class="absolute left-0 mt-0 w-72 bg-white rounded-md shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[100] border border-gray-100 py-2"
              >
                <a
                  href="00_mawp_calculator.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Calculadora MAWP</a
                >
                <a
                  href="01_pipe_thickness.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Espesores de Tubería</a
                >
                <a
                  href="02_hoop_stress.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Esfuerzo Circunferencial</a
                >
                <a
                  href="03_max_design_pressure.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Presión Máxima Diseño</a
                >
                <a
                  href="05_flow_std_to_actual.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Flujo Estándar a Actual</a
                >
                <a
                  href="06_gas_properties.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Propiedades de Gases</a
                >
                <a
                  href="07_velocidad_erosional_-_eng_esp.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Velocidad Erosional</a
                >
                <a
                  href="08_gas_compression.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Compresión de Gas</a
                >
                <a
                  href="09_tank_volume.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Volumen de Tanques</a
                >
                <a
                  href="10_z_factor_cnga.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Factor Z (CNGA)</a
                >
                <a
                  href="11_line_pack.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] border-b border-gray-50 font-normal"
                  >Line Pack</a
                >
                <a
                  href="12_pipe_weight.html"
                  class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#006097] font-normal"
                  >Peso de Tuberías</a
                >
              </div>
            </div>

            <a
              href="../index.html#expertise"
              class="text-white hover:opacity-80 px-3 py-2 rounded-md text-sm font-medium transition-colors relative group"
            >
              Expertise
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="../index.html#contact"
              class="bg-white text-[#006097] px-5 py-2.5 rounded-md text-sm font-bold hover:bg-gray-100 transition-all shadow-md ml-4"
            >
              Contactar
            </a>
          </div>

          <!-- Mobile Menu Button -->
          <div class="flex items-center md:hidden">
            <button
              id="mobile-menu-button"
              type="button"
              class="inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-[#005080] focus:outline-none transition-colors"
              aria-controls="mobile-menu"
              aria-expanded="false"
            >
              <span class="sr-only">Abrir menú</span>
              <svg
                id="menu-icon"
                class="block h-6 w-6"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              <svg
                id="close-icon"
                class="hidden h-6 w-6"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Menu -->
      <div
        id="mobile-menu"
        class="hidden md:hidden bg-[#006097] border-t border-[#005080] overflow-y-auto max-h-[calc(100vh-80px)]"
      >
        <div class="px-2 pt-2 pb-3 space-y-1">
          <a
            href="../index.html"
            class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-[#005080]"
            >Inicio</a
          >

          <!-- Mobile Accordion -->
          <div>
            <button
              id="mobile-tools-toggle"
              class="w-full flex items-center justify-between text-white px-3 py-2 rounded-md text-base font-medium hover:bg-[#005080] transition-colors"
            >
              Herramientas
              <svg
                id="mobile-tools-arrow"
                class="w-4 h-4 transition-transform duration-200"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
            <div
              id="mobile-tools-menu"
              class="hidden pl-4 space-y-1 bg-[#005080]/50 rounded-md mt-1"
            >
              <a
                href="00_mawp_calculator.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Calculadora MAWP</a
              >
              <a
                href="01_pipe_thickness.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Espesores de Tubería</a
              >
              <a
                href="02_hoop_stress.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Esfuerzo Circunferencial</a
              >
              <a
                href="03_max_design_pressure.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Presión Máxima Diseño</a
              >
              <a
                href="05_flow_std_to_actual.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Flujo Estándar a Actual</a
              >
              <a
                href="06_gas_properties.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Propiedades de Gases</a
              >
              <a
                href="07_velocidad_erosional_-_eng_esp.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Velocidad Erosional</a
              >
              <a
                href="08_gas_compression.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Compresión de Gas</a
              >
              <a
                href="09_tank_volume.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Volumen de Tanques</a
              >
              <a
                href="10_z_factor_cnga.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Factor Z (CNGA)</a
              >
              <a
                href="11_line_pack.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Line Pack</a
              >
              <a
                href="12_pipe_weight.html"
                class="text-white/90 block px-3 py-2 rounded-md text-sm hover:bg-[#005080]"
                >Peso de Tuberías</a
              >
            </div>
          </div>

          <a
            href="../index.html#expertise"
            class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-[#005080]"
            >Expertise</a
          >
          <a
            href="../index.html#projects"
            class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-[#005080]"
            >Proyectos</a
          >
          <a
            href="../index.html#contact"
            class="text-white block px-3 py-2 rounded-md text-base font-medium hover:bg-[#005080]"
            >Contacto</a
          >
          <div class="pt-2">
            <a
              href="../index.html#contact"
              class="w-full text-center block bg-white text-[#006097] px-5 py-3 rounded-md text-base font-bold hover:bg-gray-100"
            >
              Contactar
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="container pt-24 pb-12">
      <!-- Breadcrumb -->
      <nav
        class="flex mb-6 text-xs font-medium text-gray-400 uppercase-none"
        aria-label="Breadcrumb"
      >
        <ol class="inline-flex items-center space-x-2">
          <li>
            <a
              href="../index.html"
              class="text-gray-600 hover:text-primary transition-colors"
              >Inicio</a
            >
          </li>
          <li><span class="mx-2">/</span></li>
          <li>
            <a
              href="../herramientas.html"
              class="text-gray-600 hover:text-primary transition-colors"
              >Herramientas</a
            >
          </li>
          <li><span class="mx-2">/</span></li>
          <li class="text-gray-900 font-bold">Peso de Tuberías</li>
        </ol>
      </nav>

      <div class="title-box">
        <h1 class="text-3xl font-bold">
          Pipe Weight & Technical Properties Calculator
        </h1>
        <p class="text-gray-100 mt-1">
          Total Project Tonnage & Unit Weight Estimates
        </p>
      </div>

      <div class="card">
        <h2>Enter Pipe Data</h2>
        <div class="input-row">
          <div class="input-group">
            <label for="npsSel" class="required"
              >Nominal Pipe Size (NPS):</label
            >
            <select id="npsSel" onchange="fillSch()"></select>
          </div>
          <div class="input-group">
            <label for="schSel" class="required">Schedule / Class:</label>
            <select id="schSel"></select>
          </div>
          <div class="input-group">
            <label for="lenInp" class="required">Length:</label>
            <input
              id="lenInp"
              type="number"
              step="any"
              min="0"
              placeholder="e.g. 12"
            />
          </div>
          <div class="input-group">
            <label for="unitSel" class="required">Unit:</label>
            <select id="unitSel">
              <option value="m">Meters (m)</option>
              <option value="ft">Feet (ft)</option>
            </select>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 items-center justify-between mt-4">
          <div class="flex gap-4">
            <button class="primary" id="addBtn">Add to Project</button>
            <button class="bg-gray-500 hover:bg-gray-600" id="clearBtn">
              Clear Project
            </button>
            <button id="exportBtn">Export CSV</button>
          </div>
          <label
            class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer"
          >
            <input id="toggleEdit" type="checkbox" onchange="render()" />
            <span>Enable weight editing in table</span>
          </label>
        </div>

        <div class="mt-2 text-xs text-gray-500 italic">
          Note: STD ≡ Sch 40 (NPS ≤ 10), XS ≡ Sch 80 (NPS ≤ 8).
        </div>
      </div>

      <div class="card overflow-x-auto">
        <h2>Project Table</h2>
        <table id="resTable" class="min-w-full">
          <thead>
            <tr>
              <th>#</th>
              <th>NPS</th>
              <th>SCH</th>
              <th class="text-right">Length</th>
              <th>Unit</th>
              <th class="text-right">kg/m</th>
              <th class="text-right">lb/ft</th>
              <th class="text-right">Total (kg)</th>
              <th class="text-right">Total (lb)</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Lines added here -->
          </tbody>
          <tfoot>
            <tr class="font-bold bg-gray-50">
              <td colspan="7" class="text-right">Total Project Weight:</td>
              <td class="text-right" id="totKg">0.000</td>
              <td class="text-right" id="totLb">0.000</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <details class="text-sm text-gray-600 mt-4 cursor-pointer">
        <summary class="font-semibold text-primary mb-2">
          Import / Update Catalogue via CSV
        </summary>
        <div class="card p-4">
          <p class="mb-2">
            Format: <code>NPS, SCH, kg/m, lb/ft</code> (One per line)
          </p>
          <textarea
            id="csvArea"
            rows="4"
            class="w-full font-mono text-xs p-2 border rounded"
            placeholder="e.g. 4, 80, 22.32, 15.00"
          ></textarea>
          <button class="mt-2 py-2 text-sm" id="btnParseCsv">
            Import Selected Data
          </button>
        </div>
      </details>

      <footer>
        <p>
          Data source: ASME B36.10M Table 1 (Standard weights). 1 lb =
          0.45359237 kg.
        </p>
        <p>(C) 2025. Creado Por Freddy Roa Monsalvo | Ingeniero Mecánico</p>
      </footer>
    </div>

    <script>
      const LB_TO_KG = 0.45359237;
      const KG_TO_LB = 2.20462262185;

      // Base database
      const WEIGHTS = {
        "1/2": {
          40: { kgm: 1.27, lbft: 0.85 },
          80: { kgm: 1.62, lbft: 1.09 },
          160: { kgm: 1.95, lbft: 1.31 },
          XXS: { kgm: 2.55, lbft: 1.72 },
        },
        "3/4": {
          40: { kgm: 1.69, lbft: 1.13 },
          80: { kgm: 2.2, lbft: 1.48 },
          160: { kgm: 2.9, lbft: 1.95 },
          XXS: { kgm: 3.64, lbft: 2.44 },
        },
        1: {
          40: { kgm: 2.5, lbft: 1.68 },
          80: { kgm: 3.24, lbft: 2.17 },
          160: { kgm: 4.24, lbft: 2.85 },
          XXS: { kgm: 5.45, lbft: 3.66 },
        },
        2: {
          5: { kgm: 2.39, lbft: 1.61 },
          10: { kgm: 3.93, lbft: 2.64 },
          30: { kgm: 4.48, lbft: 3.01 },
          40: { kgm: 5.44, lbft: 3.66 },
          80: { kgm: 7.48, lbft: 5.03 },
          160: { kgm: 11.11, lbft: 7.14 },
          XXS: { kgm: 13.44, lbft: 9.04 },
        },
        3: {
          40: { kgm: 11.29, lbft: 7.58 },
          80: { kgm: 15.27, lbft: 10.26 },
          160: { kgm: 21.35, lbft: 14.34 },
          XXS: { kgm: 27.68, lbft: 18.6 },
        },
        4: {
          5: { kgm: 5.84, lbft: 3.92 },
          10: { kgm: 8.37, lbft: 5.62 },
          30: { kgm: 12.91, lbft: 8.67 },
          40: { kgm: 16.08, lbft: 10.8 },
          60: { kgm: 22.32, lbft: 15.0 },
          80: { kgm: 22.32, lbft: 15.0 },
          100: { kgm: 28.32, lbft: 19.02 },
          120: { kgm: 33.54, lbft: 22.53 },
          160: { kgm: 41.03, lbft: 27.57 },
          XXS: { kgm: 41.03, lbft: 27.57 },
        },
        6: {
          40: { kgm: 28.26, lbft: 18.99 },
          80: { kgm: 48.73, lbft: 32.74 },
          120: { kgm: 59.69, lbft: 40.09 },
          160: { kgm: 70.12, lbft: 47.1 },
          XXS: { kgm: 79.22, lbft: 53.21 },
        },
        8: {
          20: { kgm: 19.97, lbft: 13.41 },
          40: { kgm: 34.39, lbft: 23.1 },
          80: { kgm: 61.7, lbft: 41.48 },
          120: { kgm: 97.44, lbft: 65.48 },
        },
        10: {
          5: { kgm: 22.61, lbft: 15.21 },
          10: { kgm: 27.78, lbft: 18.67 },
          20: { kgm: 41.76, lbft: 28.06 },
          30: { kgm: 51.01, lbft: 34.27 },
          40: { kgm: 60.29, lbft: 40.52 },
          60: { kgm: 81.53, lbft: 54.79 },
          80: { kgm: 100.69, lbft: 67.65 },
          100: { kgm: 114.71, lbft: 77.1 },
          120: { kgm: 133.01, lbft: 89.38 },
          140: { kgm: 155.1, lbft: 104.23 },
          160: { kgm: 188.9, lbft: 126.94 },
          XXS: { kgm: 155.1, lbft: 104.23 },
        },
        12: {
          40: { kgm: 73.86, lbft: 49.61 },
          80: { kgm: 120.59, lbft: 81.01 },
          120: { kgm: 165.33, lbft: 111.08 },
          160: { kgm: 228.68, lbft: 153.67 },
        },
        24: {
          10: { kgm: 94.46, lbft: 63.47 },
          20: { kgm: 141.12, lbft: 94.71 },
          30: { kgm: 209.65, lbft: 140.81 },
          40: { kgm: 255.43, lbft: 171.45 },
          60: { kgm: 366.19, lbft: 245.87 },
          80: { kgm: 452.77, lbft: 304.0 },
          100: { kgm: 557.97, lbft: 374.66 },
          120: { kgm: 640.07, lbft: 429.79 },
          140: { kgm: 720.19, lbft: 483.57 },
          160: { kgm: 808.27, lbft: 542.64 },
        },
      };

      const NPS_ORDER = [
        "1/8",
        "1/4",
        "3/8",
        "1/2",
        "3/4",
        "1",
        "1-1/4",
        "1-1/2",
        "2",
        "2-1/2",
        "3",
        "3-1/2",
        "4",
        "5",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "30",
        "32",
        "34",
        "36",
      ];
      const SCH_ORDER = [
        "5",
        "10",
        "20",
        "30",
        "40",
        "60",
        "80",
        "100",
        "120",
        "140",
        "160",
        "XXS",
      ];

      let rows = JSON.parse(localStorage.getItem("pipeRows") || "[]");
      const persist = () =>
        localStorage.setItem("pipeRows", JSON.stringify(rows));
      const fmt = (n) => (Math.round(n * 1000) / 1000).toFixed(3);

      const npsSel = document.getElementById("npsSel");
      const schSel = document.getElementById("schSel");
      const lenInp = document.getElementById("lenInp");
      const unitSel = document.getElementById("unitSel");

      function fillNps() {
        npsSel.innerHTML = "";
        const npsAvail = NPS_ORDER.filter((n) => WEIGHTS[n]);
        for (const nps of npsAvail) {
          const opt = document.createElement("option");
          opt.value = nps;
          opt.textContent = nps + '"';
          npsSel.appendChild(opt);
        }
      }

      function fillSch() {
        schSel.innerHTML = "";
        const nps = npsSel.value;
        const schs = Object.keys(WEIGHTS[nps] || {});
        schs.sort((a, b) => {
          const ai = SCH_ORDER.indexOf(a) === -1 ? 999 : SCH_ORDER.indexOf(a);
          const bi = SCH_ORDER.indexOf(b) === -1 ? 999 : SCH_ORDER.indexOf(b);
          return ai - bi;
        });
        for (const s of schs) {
          const txt = s === "40" ? "40 (STD)" : s === "80" ? "80 (XS)" : s;
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = txt;
          schSel.appendChild(opt);
        }
      }

      function parseNumber(s) {
        if (typeof s === "number") return s;
        if (!s) return NaN;
        return parseFloat(("" + s).trim().replace(",", "."));
      }

      function addLine() {
        const nps = npsSel.value;
        const sch = schSel.value;
        const L = parseNumber(lenInp.value);
        const unit = unitSel.value;
        if (!nps || !sch || !(L > 0)) {
          alert("Enter valid NPS, Schedule and Length.");
          return;
        }
        const data = WEIGHTS[nps][sch];
        rows.push({ nps, sch, L, unit, kgm: data.kgm, lbft: data.lbft });
        persist();
        lenInp.value = "";
        render();
      }

      function render() {
        const tbody = document.querySelector("#resTable tbody");
        tbody.innerHTML = "";
        let sumKg = 0,
          sumLb = 0;

        rows.forEach((r, idx) => {
          let totKg = r.unit === "m" ? r.kgm * r.L : r.lbft * r.L * LB_TO_KG;
          let totLb = r.unit === "ft" ? r.lbft * r.L : r.kgm * r.L * KG_TO_LB;
          sumKg += totKg;
          sumLb += totLb;

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${r.nps}"</td>
                    <td>${r.sch === "40" ? "40 (STD)" : r.sch === "80" ? "80 (XS)" : r.sch}</td>
                    <td class="text-right">${fmt(r.L)}</td>
                    <td>${r.unit}</td>
                    <td class="text-right"><span class="editable" data-idx="${idx}" data-field="kgm">${fmt(r.kgm)}</span></td>
                    <td class="text-right"><span class="editable" data-idx="${idx}" data-field="lbft">${fmt(r.lbft)}</span></td>
                    <td class="text-right">${fmt(totKg)}</td>
                    <td class="text-right">${fmt(totLb)}</td>
                    <td class="text-center"><button class="bg-red-500 hover:bg-red-600 px-2 py-1 text-xs" onclick="removeLine(${idx})">Remove</button></td>
                `;
          tbody.appendChild(tr);
        });

        document.getElementById("totKg").textContent = fmt(sumKg);
        document.getElementById("totLb").textContent = fmt(sumLb);

        const canEdit = document.getElementById("toggleEdit").checked;
        document.querySelectorAll(".editable").forEach((span) => {
          span.contentEditable = canEdit;
          if (canEdit) {
            span.addEventListener("blur", (e) => {
              const idx = span.dataset.idx;
              const field = span.dataset.field;
              const val = parseNumber(span.textContent);
              if (val > 0) {
                if (field === "kgm") {
                  rows[idx].kgm = val;
                  rows[idx].lbft = (val * KG_TO_LB) / 3.28084;
                } else {
                  rows[idx].lbft = val;
                  rows[idx].kgm = val * LB_TO_KG * 3.28084;
                }
                persist();
                render();
              } else {
                render();
              }
            });
          }
        });
      }

      window.removeLine = (idx) => {
        rows.splice(idx, 1);
        persist();
        render();
      };

      document.getElementById("addBtn").onclick = addLine;
      document.getElementById("clearBtn").onclick = () => {
        if (confirm("Clear all project lines?")) {
          rows = [];
          persist();
          render();
        }
      };
      document.getElementById("exportBtn").onclick = () => {
        let csv = "NPS,SCH,Length,Unit,kg/m,lb/ft,Total kg,Total lb\n";
        rows.forEach((r) => {
          const tkg = r.unit === "m" ? r.kgm * r.L : r.lbft * r.L * LB_TO_KG;
          const tlb = r.unit === "ft" ? r.lbft * r.L : r.kgm * r.L * KG_TO_LB;
          csv += `${r.nps},${r.sch},${r.L},${r.unit},${r.kgm},${r.lbft},${fmt(tkg)},${fmt(tlb)}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "pipe_project_weight.csv";
        a.click();
      };

      document.getElementById("btnParseCsv").onclick = () => {
        const txt = document.getElementById("csvArea").value.trim();
        if (!txt) return;
        txt.split("\n").forEach((line) => {
          const [nps, sch, kgm, lbft] = line.split(",").map((s) => s.trim());
          if (nps && sch && parseNumber(kgm) > 0) {
            WEIGHTS[nps] = WEIGHTS[nps] || {};
            WEIGHTS[nps][sch] = {
              kgm: parseNumber(kgm),
              lbft: parseNumber(lbft),
            };
          }
        });
        fillNps();
        fillSch();
        alert("Catalogue updated.");
      };

      fillNps();
      fillSch();
      render();

      // Mobile Menu Toggle
      document.addEventListener("DOMContentLoaded", () => {
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        const closeIcon = document.getElementById("close-icon");
        const mobileToolsToggle = document.getElementById(
          "mobile-tools-toggle",
        );
        const mobileToolsMenu = document.getElementById("mobile-tools-menu");
        const mobileToolsArrow = document.getElementById("mobile-tools-arrow");

        if (mobileMenuButton && mobileMenu) {
          mobileMenuButton.addEventListener("click", () => {
            const isExpanded =
              mobileMenuButton.getAttribute("aria-expanded") === "true";
            mobileMenu.classList.toggle("hidden");
            menuIcon.classList.toggle("hidden");
            closeIcon.classList.toggle("hidden");
            mobileMenuButton.setAttribute("aria-expanded", !isExpanded);
          });

          // Mobile Tools Accordion
          if (mobileToolsToggle && mobileToolsMenu) {
            mobileToolsToggle.addEventListener("click", (e) => {
              e.preventDefault();
              mobileToolsMenu.classList.toggle("hidden");
              if (mobileToolsArrow)
                mobileToolsArrow.classList.toggle("rotate-180");
            });
          }

          // Close menu when clicking a link (except tools toggle)
          const mobileLinks = mobileMenu.querySelectorAll("a");
          mobileLinks.forEach((link) => {
            if (link.id !== "mobile-tools-toggle") {
              link.addEventListener("click", () => {
                mobileMenu.classList.add("hidden");
                menuIcon.classList.remove("hidden");
                closeIcon.classList.add("hidden");
                mobileMenuButton.setAttribute("aria-expanded", "false");
              });
            }
          });
        }
      });
    </script>
  </body>
</html>
