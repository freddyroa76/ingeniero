<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Ing. Freddy Roa Monsalvo" />
    <meta
      name="description"
      content="Calculadora de Velocidad Erosional API RP14E - Engineering Tool"
    />
    <title>API RP14E Calculator | Ing. Freddy Roa</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* --- ESTILOS GENERALES --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        color: #333;
        min-height: 100vh;
        padding-bottom: 80px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
      }

      /* --- BARRA SUPERIOR --- */
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 0 10px;
      }

      .engineer-brand {
        font-weight: bold;
        color: #fff;
        font-size: 14px;
        opacity: 0.8;
        letter-spacing: 1px;
      }

      .lang-switch-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #fff;
        padding: 6px 15px;
        border-radius: 30px;
        border: 2px solid #1976d2;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .lang-label {
        color: #0d47a1;
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #b0bec5;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #0d47a1;
      }
      input:checked + .slider:before {
        transform: translateX(22px);
      }

      /* --- HEADER --- */
      .title-box {
        background: linear-gradient(135deg, #004d40, #00695c);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-bottom: 5px solid #00251a;
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        margin: 0;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }
      .subtitle {
        font-size: 16px;
        margin-top: 8px;
        opacity: 0.95;
        font-weight: 500;
      }

      /* --- LAYOUT --- */
      .main-content {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
      }
      .column {
        flex: 1;
        min-width: 340px;
        display: flex;
        flex-direction: column;
      }

      .section {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        background: white;
        flex-grow: 1;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
        transition: transform 0.2s;
      }
      .section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-weight: 800;
        color: #00695c;
        margin-bottom: 25px;
        padding-bottom: 12px;
        border-bottom: 2px solid #004d40;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* --- INPUTS --- */
      .input-group {
        margin-bottom: 18px;
      }
      .input-label {
        display: block;
        margin-bottom: 6px;
        font-size: 14px;
        color: #37474f;
        font-weight: 700;
      }
      .units {
        color: #d32f2f;
        font-weight: 600;
        font-size: 0.9em;
        margin-left: 4px;
      }

      select,
      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #cfd8dc;
        border-radius: 6px;
        font-size: 15px;
        transition: all 0.3s;
        background-color: #fcfcfc;
        color: #333;
        font-family: monospace;
      }
      select:focus,
      input[type="number"]:focus {
        border-color: #00695c;
        outline: none;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(0, 105, 92, 0.1);
      }
      input[readonly] {
        background-color: #eceff1;
        color: #546e7a;
        border-color: #b0bec5;
        font-weight: 700;
        cursor: not-allowed;
      }

      /* --- BOTONES --- */
      .button-group {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #ddd;
      }
      .calc-button {
        padding: 16px;
        font-size: 16px;
        font-weight: 800;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .calc-button.calculate {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
      }
      .calc-button.calculate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(46, 125, 50, 0.3);
      }
      .calc-button.clear {
        background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
      }
      .calc-button.clear:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(198, 40, 40, 0.3);
      }

      /* --- COMPOSICIÓN DE GAS --- */
      .gas-composition {
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #fafafa;
      }
      .gas-row {
        display: flex;
        margin-bottom: 12px;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px dotted #eee;
        padding-bottom: 5px;
      }
      .gas-label {
        font-weight: 600;
        font-size: 14px;
        color: #455a64;
        flex: 1;
      }
      .gas-input {
        width: 100px !important;
        padding: 6px 10px !important;
        text-align: right;
        font-weight: bold;
        color: #00695c;
      }
      .composition-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 800;
        color: #004d40;
        padding: 0 10px;
        border-bottom: 2px solid #004d40;
      }

      /* --- VALIDACIÓN --- */
      .sum-validation {
        padding: 12px;
        margin-top: 15px;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
        border-width: 2px;
        border-style: solid;
      }
      .sum-valid {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-color: #a5d6a7;
      }
      .sum-invalid {
        background-color: #ffebee;
        color: #c62828;
        border-color: #ef9a9a;
      }

      /* --- MODAL --- */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background-color: #fff;
        margin: 4vh auto;
        padding: 30px;
        border-radius: 15px;
        width: 95%;
        max-width: 900px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        max-height: 92vh;
        overflow-y: auto;
        position: relative;
      }
      .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #90a4ae;
        transition: color 0.2s;
      }
      .close:hover {
        color: #d32f2f;
      }

      .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .result-item {
        padding: 20px;
        background: #f1f8e9;
        border-radius: 10px;
        border-left: 5px solid #2e7d32;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .result-label {
        font-size: 12px;
        text-transform: uppercase;
        color: #546e7a;
        font-weight: 800;
        margin-bottom: 8px;
      }
      .result-value {
        font-size: 20px;
        font-weight: 800;
        color: #1b5e20;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .results-table th {
        background-color: #00695c;
        color: white;
        padding: 14px;
        text-transform: uppercase;
        font-size: 13px;
      }
      .results-table td {
        border: 1px solid #e0e0e0;
        padding: 12px;
        text-align: center;
      }
      .results-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .results-table tr:hover {
        background-color: #e0f2f1;
      }

      /* --- WHATSAPP --- */
      .whatsapp-float {
        position: fixed;
        width: 60px;
        height: 60px;
        bottom: 30px;
        right: 30px;
        background-color: #25d366;
        color: #fff;
        border-radius: 50px;
        text-align: center;
        font-size: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      .whatsapp-float:hover {
        transform: scale(1.1);
        background-color: #128c7e;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
      }
      .whatsapp-tooltip {
        position: absolute;
        right: 70px;
        background-color: #333;
        color: #fff;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .whatsapp-float:hover .whatsapp-tooltip {
        opacity: 1;
      }

      /* --- FOOTER --- */
      .footer-engineer {
        text-align: center;
        margin-top: 40px;
        padding: 15px;
        color: #cfd8dc;
        font-size: 13px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .footer-engineer strong {
        color: #fff;
      }

      @media (max-width: 900px) {
        .main-content {
          flex-direction: column;
        }
        .gas-input {
          width: 80px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="engineer-brand">
        <i class="fas fa-hard-hat"></i> ING. FREDDY ROA MONSALVO
      </div>
      <div class="lang-switch-wrapper">
        <span class="lang-label" onclick="setLang('en')">EN</span>
        <label class="switch">
          <input
            type="checkbox"
            id="languageToggle"
            onchange="toggleLanguage()"
          />
          <span class="slider"></span>
        </label>
        <span class="lang-label" onclick="setLang('es')">ES</span>
      </div>
    </div>

    <div class="container">
      <div class="title-box">
        <h1 class="title" data-i18n="title">
          Natural Gas Erosional Velocity Calculator
        </h1>
        <div class="subtitle" data-i18n="subtitle">
          API RP14E for gas system design
        </div>
      </div>

      <div class="main-content">
        <div class="column">
          <div class="section">
            <div class="section-title" data-i18n="sec_gas">
              <i class="fas fa-flask"></i> Gas Composition (Mole %)
            </div>
            <div class="composition-header">
              <div data-i18n="header_comp">Component</div>
              <div data-i18n="header_frac">Fraction</div>
            </div>
            <div class="gas-composition" id="gasComposition"></div>
            <div id="sumValidation" class="sum-validation sum-invalid">
              <span data-i18n="val_sum">Sum of mole fractions: </span
              ><span id="sumValue">0.0000</span>
            </div>
            <div
              class="info-text"
              style="margin-top: 10px; font-size: 12px; color: #666"
              data-i18n="info_paste"
            >
              Use Ctrl+V to paste from Excel. Sum must equal 1.
            </div>
          </div>
        </div>

        <div class="column">
          <div class="section">
            <div class="section-title" data-i18n="sec_op">
              <i class="fas fa-sliders-h"></i> Operational Parameters
            </div>
            <div class="input-group">
              <label class="input-label" data-i18n="lbl_pop"
                >Operating Pressure <span class="units">(psig)</span></label
              >
              <input
                type="number"
                id="presionOperacion"
                step="0.1"
                placeholder="Enter pressure"
                data-i18n-ph="ph_press"
              />
            </div>
            <div class="input-group">
              <label class="input-label" data-i18n="lbl_patm"
                >Atmospheric Pressure <span class="units">(psia)</span></label
              >
              <input
                type="number"
                id="presionAtmosferica"
                value="14.65"
                step="0.01"
              />
            </div>
            <div class="input-group">
              <label class="input-label" data-i18n="lbl_top"
                >Operating Temperature <span class="units">(°F)</span></label
              >
              <input
                type="number"
                id="temperaturaOperacion"
                step="0.1"
                placeholder="Enter temperature"
                data-i18n-ph="ph_temp"
              />
            </div>
            <div class="input-group">
              <label class="input-label" data-i18n="lbl_flow"
                >Gas Flow Rate <span class="units">(MMSCFD)</span></label
              >
              <input
                type="number"
                id="flujoGas"
                step="0.01"
                placeholder="Enter flow"
                data-i18n-ph="ph_flow"
              />
            </div>
            <div class="input-group">
              <label class="input-label" data-i18n="lbl_const"
                >Custom C Constant</label
              >
              <input
                type="number"
                id="constanteC"
                step="1"
                placeholder="Optional"
                data-i18n-ph="ph_opt"
              />
            </div>
            <div
              class="info-text"
              data-i18n="info_std"
              style="font-size: 12px; color: #666; font-style: italic"
            >
              Standard values: 100, 125, 150, 200, 250
            </div>
          </div>
        </div>

        <div class="column">
          <div class="section">
            <div class="section-title" data-i18n="sec_pipe">
              <i class="fas fa-pipe"></i> Pipe Parameters (ASME B36.10M)
            </div>

            <div class="input-group">
              <label class="input-label" data-i18n="lbl_dn"
                >Nominal Diameter</label
              >
              <select id="pipeSize" onchange="updatePipeDimensions()">
                <option value="" data-i18n="sel_size">Select Size</option>
              </select>
            </div>

            <div class="input-group">
              <label class="input-label">Schedule</label>
              <select id="schedule" onchange="updateWallThickness()" disabled>
                <option value="" data-i18n="sel_sch">Select Schedule</option>
              </select>
            </div>

            <div class="input-group">
              <label class="input-label" data-i18n="lbl_od"
                >Outside Diameter, OD <span class="units">(in)</span></label
              >
              <input type="number" id="outsideDiameter" readonly step="0.001" />
            </div>

            <div class="input-group">
              <label class="input-label" data-i18n="lbl_wt"
                >Wall Thickness, t <span class="units">(in)</span></label
              >
              <input type="number" id="wallThickness" readonly step="0.001" />
            </div>

            <div class="input-group">
              <label class="input-label" data-i18n="lbl_id"
                >Inside Diameter, ID <span class="units">(in)</span></label
              >
              <input type="number" id="insideDiameter" readonly step="0.001" />
            </div>
          </div>

          <div class="button-group">
            <button
              class="calc-button calculate"
              onclick="calcular()"
              data-i18n="btn_calc"
            >
              <i class="fas fa-calculator"></i> Calculate
            </button>
            <button
              class="calc-button clear"
              onclick="limpiarCampos()"
              data-i18n="btn_clear"
            >
              <i class="fas fa-broom"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <div
        class="section"
        style="margin-top: 20px; background: #e0f2f1; border-color: #80cbc4"
      >
        <div class="section-title" data-i18n="sec_tech" style="color: #00695c">
          <i class="fas fa-info-circle"></i> Technical Info - API RP14E
        </div>
        <p data-i18n="tech_form">
          <strong>Erosional Velocity Formula:</strong>
        </p>
        <div
          style="
            font-family: monospace;
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            margin: 15px 0;
            border: 1px dashed #00897b;
            font-size: 1.1em;
          "
        >
          Vₑ = C / √ρ
        </div>
        <p data-i18n="tech_where" style="font-size: 14px; line-height: 1.6">
          Where:<br />Vₑ = Erosional Velocity (ft/s)<br />C = Empirical Constant
          (API RP14E)<br />ρ = Gas Density (lb/ft³)
        </p>
      </div>
    </div>

    <a
      href="https://wa.me/573112531330?text=Hola%20Ing.%20Freddy%2C%20estoy%20usando%20tu%20calculadora%20API%20RP14E%20y%20quisiera%20contactarte."
      class="whatsapp-float"
      target="_blank"
    >
      <i class="fab fa-whatsapp"></i>
      <span class="whatsapp-tooltip">Contactar al Ing. Freddy Roa</span>
    </a>

    <div class="footer-engineer">
      &copy; 2025. Developed by <strong>Ing. Freddy Roa Monsalvo</strong> |
      <br />
      <span style="font-size: 11px; opacity: 0.7">Mechanical Engineer</span>
    </div>

    <div id="resultModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2
          style="text-align: center; color: #00695c; margin-bottom: 20px"
          data-i18n="res_title"
        >
          Calculation Results
        </h2>
        <div class="result-grid">
          <div class="result-item">
            <div class="result-label" data-i18n="res_mw">Molecular Weight</div>
            <div class="result-value" id="resultPM">0.0000</div>
            <span class="result-unit">g/mol</span>
          </div>
          <div class="result-item">
            <div class="result-label" data-i18n="res_sg">Specific Gravity</div>
            <div class="result-value" id="resultGE">0.0000</div>
          </div>
          <div class="result-item">
            <div class="result-label" data-i18n="res_z">
              Compressibility Factor (Z)
            </div>
            <div class="result-value" id="resultZ">0.0000</div>
          </div>
          <div class="result-item">
            <div class="result-label" data-i18n="res_rho">Density</div>
            <div class="result-value" id="resultDensidad">0.0000</div>
            <span class="result-unit">lb/ft³</span>
          </div>
          <div class="result-item">
            <div class="result-label" data-i18n="res_flow">Actual Flow</div>
            <div class="result-value" id="resultACFM">0.00</div>
            <span class="result-unit">ACFM</span>
          </div>
          <div class="result-item">
            <div class="result-label" data-i18n="res_vel">Flow Velocity</div>
            <div class="result-value" id="resultVelocidad">0.00</div>
            <span class="result-unit">ft/s</span>
          </div>
        </div>
        <h3
          style="
            margin-top: 30px;
            color: #00695c;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
          "
          data-i18n="comp_title"
        >
          Erosional Velocity Comparison
        </h3>
        <table class="results-table">
          <thead>
            <tr>
              <th data-i18n="th_c">Constant C</th>
              <th data-i18n="th_vflow">Flow Velocity (ft/s)</th>
              <th data-i18n="th_veros">Erosional Velocity (ft/s)</th>
              <th data-i18n="th_perc">Percentage (%)</th>
            </tr>
          </thead>
          <tbody id="tablaResultados"></tbody>
        </table>
      </div>
    </div>

    <script>
      let currentLang = "en";

      // --- BASE DE DATOS ASME B36.10M COMPLETA ---
      // Generada a partir de la imagen proporcionada y norma estándar
      const pipeDimensions = {
        0.125: {
          OD: 0.405,
          label: "NPS 1/8",
          schedules: { 10: 0.049, STD: 0.068, 40: 0.068, 80: 0.095, XS: 0.095 },
        },
        0.25: {
          OD: 0.54,
          label: "NPS 1/4",
          schedules: { 10: 0.065, STD: 0.088, 40: 0.088, 80: 0.119, XS: 0.119 },
        },
        0.375: {
          OD: 0.675,
          label: "NPS 3/8",
          schedules: { 10: 0.065, STD: 0.091, 40: 0.091, 80: 0.126, XS: 0.126 },
        },
        0.5: {
          OD: 0.84,
          label: "NPS 1/2",
          schedules: {
            5: 0.065,
            10: 0.083,
            STD: 0.109,
            40: 0.109,
            80: 0.147,
            XS: 0.147,
            160: 0.187,
            XXS: 0.294,
          },
        },
        0.75: {
          OD: 1.05,
          label: "NPS 3/4",
          schedules: {
            5: 0.065,
            10: 0.083,
            STD: 0.113,
            40: 0.113,
            80: 0.154,
            XS: 0.154,
            160: 0.219,
            XXS: 0.308,
          },
        },
        1: {
          OD: 1.315,
          label: "NPS 1",
          schedules: {
            5: 0.065,
            10: 0.109,
            STD: 0.133,
            40: 0.133,
            80: 0.179,
            XS: 0.179,
            160: 0.25,
            XXS: 0.358,
          },
        },
        1.25: {
          OD: 1.66,
          label: "NPS 1 1/4",
          schedules: {
            5: 0.065,
            10: 0.109,
            STD: 0.14,
            40: 0.14,
            80: 0.191,
            XS: 0.191,
            160: 0.25,
            XXS: 0.382,
          },
        },
        1.5: {
          OD: 1.9,
          label: "NPS 1 1/2",
          schedules: {
            5: 0.065,
            10: 0.109,
            STD: 0.145,
            40: 0.145,
            80: 0.2,
            XS: 0.2,
            160: 0.281,
            XXS: 0.4,
          },
        },
        2: {
          OD: 2.375,
          label: "NPS 2",
          schedules: {
            5: 0.065,
            10: 0.109,
            STD: 0.154,
            40: 0.154,
            80: 0.218,
            XS: 0.218,
            160: 0.344,
            XXS: 0.436,
          },
        },
        2.5: {
          OD: 2.875,
          label: "NPS 2 1/2",
          schedules: {
            5: 0.083,
            10: 0.12,
            STD: 0.203,
            40: 0.203,
            80: 0.276,
            XS: 0.276,
            160: 0.375,
            XXS: 0.552,
          },
        },
        3: {
          OD: 3.5,
          label: "NPS 3",
          schedules: {
            5: 0.083,
            10: 0.12,
            STD: 0.216,
            40: 0.216,
            80: 0.3,
            XS: 0.3,
            160: 0.437,
            XXS: 0.6,
          },
        },
        3.5: {
          OD: 4.0,
          label: "NPS 3 1/2",
          schedules: {
            5: 0.083,
            10: 0.12,
            STD: 0.226,
            40: 0.226,
            80: 0.318,
            XS: 0.318,
            XXS: 0.636,
          },
        },
        4: {
          OD: 4.5,
          label: "NPS 4",
          schedules: {
            5: 0.083,
            10: 0.12,
            STD: 0.237,
            40: 0.237,
            60: 0.281,
            80: 0.337,
            XS: 0.337,
            120: 0.437,
            160: 0.531,
            XXS: 0.674,
          },
        },
        4.5: {
          OD: 5.0,
          label: "NPS 4 1/2",
          schedules: { STD: 0.247, 40: 0.247, XS: 0.355, 80: 0.355, XXS: 0.71 },
        },
        5: {
          OD: 5.563,
          label: "NPS 5",
          schedules: {
            5: 0.109,
            10: 0.134,
            STD: 0.258,
            40: 0.258,
            60: 0.375,
            80: 0.375,
            XS: 0.375,
            120: 0.5,
            160: 0.625,
            XXS: 0.75,
          },
        },
        6: {
          OD: 6.625,
          label: "NPS 6",
          schedules: {
            5: 0.109,
            10: 0.134,
            STD: 0.28,
            40: 0.28,
            60: 0.432,
            80: 0.432,
            XS: 0.432,
            120: 0.562,
            160: 0.718,
            XXS: 0.864,
          },
        },
        7: {
          OD: 7.625,
          label: "NPS 7",
          schedules: { 40: 0.301, STD: 0.301, 80: 0.5, XS: 0.5, XXS: 0.875 },
        },
        8: {
          OD: 8.625,
          label: "NPS 8",
          schedules: {
            5: 0.109,
            10: 0.148,
            20: 0.25,
            30: 0.277,
            STD: 0.322,
            40: 0.322,
            60: 0.406,
            80: 0.5,
            XS: 0.5,
            100: 0.593,
            120: 0.718,
            140: 0.812,
            160: 0.906,
            XXS: 0.875,
          },
        },
        9: {
          OD: 9.625,
          label: "NPS 9",
          schedules: { 40: 0.342, STD: 0.342, 80: 0.5, XS: 0.5 },
        },
        10: {
          OD: 10.75,
          label: "NPS 10",
          schedules: {
            5: 0.134,
            10: 0.165,
            20: 0.25,
            30: 0.307,
            STD: 0.365,
            40: 0.365,
            60: 0.5,
            80: 0.593,
            XS: 0.5,
            100: 0.718,
            120: 0.843,
            140: 1.0,
            160: 1.125,
          },
        },
        11: {
          OD: 11.75,
          label: "NPS 11",
          schedules: { STD: 0.375, 40: 0.375, XS: 0.5, 80: 0.5 },
        },
        12: {
          OD: 12.75,
          label: "NPS 12",
          schedules: {
            5: 0.156,
            10: 0.18,
            20: 0.25,
            30: 0.33,
            STD: 0.375,
            40: 0.406,
            XS: 0.5,
            60: 0.562,
            80: 0.687,
            100: 0.843,
            120: 1.0,
            140: 1.125,
            160: 1.312,
          },
        },
        14: {
          OD: 14.0,
          label: "NPS 14",
          schedules: {
            10: 0.188,
            20: 0.25,
            30: 0.312,
            STD: 0.375,
            40: 0.437,
            XS: 0.5,
            60: 0.593,
            80: 0.75,
            100: 0.937,
            120: 1.093,
            140: 1.25,
            160: 1.406,
          },
        },
        16: {
          OD: 16.0,
          label: "NPS 16",
          schedules: {
            10: 0.188,
            20: 0.25,
            30: 0.312,
            STD: 0.375,
            40: 0.5,
            XS: 0.5,
            60: 0.656,
            80: 0.843,
            100: 1.031,
            120: 1.218,
            140: 1.427,
            160: 1.593,
          },
        },
        18: {
          OD: 18.0,
          label: "NPS 18",
          schedules: {
            10: 0.188,
            20: 0.25,
            30: 0.312,
            STD: 0.375,
            40: 0.562,
            XS: 0.5,
            60: 0.75,
            80: 0.937,
            100: 1.156,
            120: 1.375,
            140: 1.562,
            160: 1.781,
          },
        },
        20: {
          OD: 20.0,
          label: "NPS 20",
          schedules: {
            10: 0.218,
            20: 0.25,
            30: 0.375,
            STD: 0.375,
            40: 0.593,
            XS: 0.5,
            60: 0.812,
            80: 1.031,
            100: 1.28,
            120: 1.5,
            140: 1.75,
            160: 1.968,
          },
        },
        22: {
          OD: 22.0,
          label: "NPS 22",
          schedules: {
            10: 0.218,
            20: 0.25,
            30: 0.375,
            STD: 0.375,
            XS: 0.5,
            60: 0.875,
            80: 1.125,
            100: 1.375,
            120: 1.625,
            140: 1.875,
            160: 2.125,
          },
        },
        24: {
          OD: 24.0,
          label: "NPS 24",
          schedules: {
            10: 0.25,
            20: 0.25,
            30: 0.375,
            STD: 0.375,
            40: 0.687,
            XS: 0.5,
            60: 0.968,
            80: 1.218,
            100: 1.531,
            120: 1.812,
            140: 2.062,
            160: 2.344,
          },
        },
        26: {
          OD: 26.0,
          label: "NPS 26",
          schedules: { 10: 0.312, STD: 0.375, XS: 0.5 },
        },
        28: {
          OD: 28.0,
          label: "NPS 28",
          schedules: { 10: 0.312, 20: 0.5, 30: 0.625, STD: 0.375, XS: 0.5 },
        },
        30: {
          OD: 30.0,
          label: "NPS 30",
          schedules: { 10: 0.312, 20: 0.5, 30: 0.625, STD: 0.375, XS: 0.5 },
        },
        32: {
          OD: 32.0,
          label: "NPS 32",
          schedules: {
            10: 0.312,
            20: 0.5,
            30: 0.625,
            STD: 0.375,
            40: 0.688,
            XS: 0.5,
          },
        },
        34: {
          OD: 34.0,
          label: "NPS 34",
          schedules: {
            10: 0.312,
            20: 0.5,
            30: 0.625,
            STD: 0.375,
            40: 0.688,
            XS: 0.5,
          },
        },
        36: {
          OD: 36.0,
          label: "NPS 36",
          schedules: {
            10: 0.312,
            20: 0.5,
            30: 0.625,
            STD: 0.375,
            40: 0.75,
            XS: 0.5,
          },
        },
      };

      const gasProperties = {
        CH4: {
          name_es: "Metano",
          name_en: "Methane",
          Pc: 666.4,
          Tc: 343.0,
          MW: 16.043,
        },
        N2: {
          name_es: "Nitrógeno",
          name_en: "Nitrogen",
          Pc: 493.0,
          Tc: 227.6,
          MW: 28.013,
        },
        CO2: {
          name_es: "Dióxido de carbono",
          name_en: "Carbon Dioxide",
          Pc: 1071.0,
          Tc: 547.9,
          MW: 44.01,
        },
        C2H6: {
          name_es: "Etano",
          name_en: "Ethane",
          Pc: 706.5,
          Tc: 549.6,
          MW: 30.07,
        },
        C3H8: {
          name_es: "Propano",
          name_en: "Propane",
          Pc: 616.0,
          Tc: 665.7,
          MW: 44.097,
        },
        H2O: {
          name_es: "Vapor de agua",
          name_en: "Water Vapor",
          Pc: 3208.0,
          Tc: 1164.77,
          MW: 18.015,
        },
        H2S: {
          name_es: "Sulfuro de hidrógeno",
          name_en: "Hydrogen Sulfide",
          Pc: 1296.2,
          Tc: 672.3,
          MW: 34.082,
        },
        H2: {
          name_es: "Hidrógeno",
          name_en: "Hydrogen",
          Pc: 188.11,
          Tc: 59.94,
          MW: 2.016,
        },
        CO: {
          name_es: "Monóxido de carbono",
          name_en: "Carbon Monoxide",
          Pc: 507.63,
          Tc: 239.22,
          MW: 28.01,
        },
        O2: {
          name_es: "Oxígeno",
          name_en: "Oxygen",
          Pc: 731.43,
          Tc: 278.64,
          MW: 32.0,
        },
        nC4H10: {
          name_es: "n-Butano",
          name_en: "n-Butane",
          Pc: 550.71,
          Tc: 765.36,
          MW: 58.123,
        },
        iC4H10: {
          name_es: "Isobutano",
          name_en: "Isobutane",
          Pc: 527.9,
          Tc: 734.1,
          MW: 58.123,
        },
        nC5H12: {
          name_es: "n-Pentano",
          name_en: "n-Pentane",
          Pc: 488.6,
          Tc: 845.5,
          MW: 72.15,
        },
        iC5H12: {
          name_es: "Isopentano",
          name_en: "Isopentane",
          Pc: 490.4,
          Tc: 828.8,
          MW: 72.15,
        },
        nC6H14: {
          name_es: "Hexano",
          name_en: "Hexane",
          Pc: 436.9,
          Tc: 913.3,
          MW: 86.177,
        },
        nC7H16: {
          name_es: "Heptano",
          name_en: "Heptane",
          Pc: 396.8,
          Tc: 972.47,
          MW: 100.204,
        },
        nC8H18: {
          name_es: "Octano",
          name_en: "Octane",
          Pc: 360.6,
          Tc: 1023.89,
          MW: 114.231,
        },
        nC9H20: {
          name_es: "Nonano",
          name_en: "Nonane",
          Pc: 334.46,
          Tc: 1072.26,
          MW: 128.258,
        },
        C10H22: {
          name_es: "Decano",
          name_en: "Decane",
          Pc: 307.92,
          Tc: 1113.3,
          MW: 142.285,
        },
        He: {
          name_es: "Helio",
          name_en: "Helium",
          Pc: 32.92,
          Tc: 9.34,
          MW: 4.003,
        },
        Ar: {
          name_es: "Argón",
          name_en: "Argon",
          Pc: 710.0,
          Tc: 271.55,
          MW: 39.948,
        },
      };

      const translations = {
        es: {
          title: "Calculadora de Velocidad Erosional",
          subtitle: "API RP14E para diseño de sistemas de gas",
          sec_gas: '<i class="fas fa-flask"></i> Composición del Gas (% molar)',
          sec_op: '<i class="fas fa-sliders-h"></i> Parámetros Operacionales',
          sec_pipe:
            '<i class="fas fa-pipe"></i> Parámetros de Tubería (ASME B36.10M)',
          header_comp: "Componente",
          header_frac: "Fracción",
          lbl_pop: 'Presión de operación <span class="units">(psig)</span>',
          lbl_patm: 'Presión atmosférica <span class="units">(psia)</span>',
          lbl_top: 'Temperatura de operación <span class="units">(°F)</span>',
          lbl_flow: 'Flujo de gas <span class="units">(MMSCFD)</span>',
          lbl_const: "Constante C personalizada",
          ph_press: "Ingresar presión",
          ph_temp: "Ingresar temperatura",
          ph_flow: "Ingresar flujo",
          ph_opt: "Opcional",
          info_std: "Valores estándar: 100, 125, 150, 200, 250",
          lbl_dn: "Diámetro nominal",
          sel_size: "Seleccionar tamaño",
          sel_sch: "Seleccionar Schedule",
          lbl_od: 'Diámetro exterior, OD <span class="units">(pulg)</span>',
          lbl_wt: 'Espesor de pared, t <span class="units">(pulg)</span>',
          lbl_id: 'Diámetro interior, ID <span class="units">(pulg)</span>',
          btn_calc: '<i class="fas fa-calculator"></i> Calcular',
          btn_clear: '<i class="fas fa-broom"></i> Limpiar',
          sec_tech:
            '<i class="fas fa-info-circle"></i> Información Técnica - API RP14E',
          tech_form: "<strong>Fórmula de velocidad erosional:</strong>",
          tech_where:
            "Donde:<br>Vₑ = Velocidad erosional (ft/s)<br>C = Constante empírica (API RP14E)<br>ρ = Densidad del gas (lb/ft³)",
          res_title: "Resultados del Cálculo",
          res_mw: "Peso Molecular",
          res_sg: "Gravedad Específica",
          res_z: "Factor de Compresibilidad (Z)",
          res_rho: "Densidad",
          res_flow: "Flujo Actual",
          res_vel: "Velocidad de Flujo",
          comp_title: "Comparación de Velocidades Erosionales",
          th_c: "Constante C",
          th_vflow: "Velocidad del Flujo (ft/s)",
          th_veros: "Velocidad Erosional (ft/s)",
          th_perc: "Porcentaje (%)",
          alert_sum:
            "La suma de las fracciones debe ser 1 (100%). Suma actual: ",
          alert_req: "Por favor complete todos los campos requeridos.",
          alert_thick: "El espesor es inválido para el diámetro seleccionado.",
          val_sum: "Suma de fracciones molares: ",
          info_paste:
            "Use Ctrl+V para pegar datos desde Excel. La suma debe ser 1.",
        },
        en: {
          title: "Erosional Velocity Calculator",
          subtitle: "API RP14E for gas system design",
          sec_gas: '<i class="fas fa-flask"></i> Gas Composition (Mole %)',
          sec_op: '<i class="fas fa-sliders-h"></i> Operational Parameters',
          sec_pipe:
            '<i class="fas fa-pipe"></i> Pipe Parameters (ASME B36.10M)',
          header_comp: "Component",
          header_frac: "Fraction",
          lbl_pop: 'Operating Pressure <span class="units">(psig)</span>',
          lbl_patm: 'Atmospheric Pressure <span class="units">(psia)</span>',
          lbl_top: 'Operating Temperature <span class="units">(°F)</span>',
          lbl_flow: 'Gas Flow Rate <span class="units">(MMSCFD)</span>',
          lbl_const: "Custom C Constant",
          ph_press: "Enter pressure",
          ph_temp: "Enter temperature",
          ph_flow: "Enter flow",
          ph_opt: "Optional",
          info_std: "Standard values: 100, 125, 150, 200, 250",
          lbl_dn: "Nominal Diameter",
          sel_size: "Select Size",
          sel_sch: "Select Schedule",
          lbl_od: 'Outside Diameter, OD <span class="units">(in)</span>',
          lbl_wt: 'Wall Thickness, t <span class="units">(in)</span>',
          lbl_id: 'Inside Diameter, ID <span class="units">(in)</span>',
          btn_calc: '<i class="fas fa-calculator"></i> Calculate',
          btn_clear: '<i class="fas fa-broom"></i> Clear',
          sec_tech:
            '<i class="fas fa-info-circle"></i> Technical Info - API RP14E',
          tech_form: "<strong>Erosional Velocity Formula:</strong>",
          tech_where:
            "Where:<br>Vₑ = Erosional Velocity (ft/s)<br>C = Empirical Constant (API RP14E)<br>ρ = Gas Density (lb/ft³)",
          res_title: "Calculation Results",
          res_mw: "Molecular Weight",
          res_sg: "Specific Gravity",
          res_z: "Compressibility Factor (Z)",
          res_rho: "Density",
          res_flow: "Actual Flow",
          res_vel: "Flow Velocity",
          comp_title: "Erosional Velocity Comparison",
          th_c: "Constant C",
          th_vflow: "Flow Velocity (ft/s)",
          th_veros: "Erosional Velocity (ft/s)",
          th_perc: "Percentage (%)",
          alert_sum: "Sum of fractions must be 1 (100%). Current sum: ",
          alert_req: "Please fill all required fields with valid values.",
          alert_thick:
            "Wall thickness cannot be greater than or equal to half the OD.",
          val_sum: "Sum of mole fractions: ",
          info_paste: "Use Ctrl+V to paste from Excel. Sum must equal 1.",
        },
      };

      const PM_AIRE = 28.964;
      const PRESION_ESTANDAR = 14.65;
      const TEMPERATURA_ESTANDAR = 519.67;
      const R_UNIVERSAL_IMPERIAL = 10.73159;

      let entradasComposicion = {};

      document.addEventListener("DOMContentLoaded", function () {
        inicializarComposicionGas();
        populatePipeOptions(); // NEW: Función para llenar el select dinámicamente
        document.addEventListener("keydown", manejarEventoTeclado);
      });

      // Genera las opciones del select basadas en la DB completa
      function populatePipeOptions() {
        const select = document.getElementById("pipeSize");
        // Ordenar claves numéricamente
        const sizes = Object.keys(pipeDimensions).sort(
          (a, b) => parseFloat(a) - parseFloat(b),
        );

        // Limpiar excepto el primero
        while (select.options.length > 1) {
          select.remove(1);
        }

        sizes.forEach((size) => {
          const option = document.createElement("option");
          option.value = size;
          option.textContent = pipeDimensions[size].label;
          select.appendChild(option);
        });
      }

      function setLang(lang) {
        document.getElementById("languageToggle").checked = lang === "es";
        toggleLanguage();
      }

      function toggleLanguage() {
        const isChecked = document.getElementById("languageToggle").checked;
        currentLang = isChecked ? "es" : "en";

        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (translations[currentLang][key]) {
            el.innerHTML = translations[currentLang][key];
          }
        });

        document.querySelectorAll("[data-i18n-ph]").forEach((el) => {
          const key = el.getAttribute("data-i18n-ph");
          if (translations[currentLang][key]) {
            el.placeholder = translations[currentLang][key];
          }
        });

        const valoresActuales = {};
        for (const [key, input] of Object.entries(entradasComposicion)) {
          valoresActuales[key] = input.value;
        }
        inicializarComposicionGas();
        for (const [key, val] of Object.entries(valoresActuales)) {
          if (entradasComposicion[key]) entradasComposicion[key].value = val;
        }
        actualizarSumaFracciones();

        // Re-populate para asegurar textos si cambiasemos el label dinámicamente (actualmente static labels)
        // populatePipeOptions();
        document.getElementById("pipeSize").options[0].text =
          translations[currentLang]["sel_size"];
        const schSelect = document.getElementById("schedule");
        if (schSelect.options.length > 0)
          schSelect.options[0].text = translations[currentLang]["sel_sch"];
      }

      function inicializarComposicionGas() {
        const contenedor = document.getElementById("gasComposition");
        contenedor.innerHTML = "";
        entradasComposicion = {};

        for (const [clave, propiedades] of Object.entries(gasProperties)) {
          const fila = document.createElement("div");
          fila.className = "gas-row";

          const etiqueta = document.createElement("div");
          etiqueta.className = "gas-label";
          const nombre =
            currentLang === "es" ? propiedades.name_es : propiedades.name_en;
          etiqueta.textContent = `${clave} (${nombre})`;

          const entrada = document.createElement("input");
          entrada.type = "number";
          entrada.className = "gas-input";
          entrada.id = `gas-${clave}`;
          entrada.step = "0.0001";
          entrada.min = "0";
          entrada.max = "1";
          entrada.placeholder = "0.0000";
          entrada.addEventListener("input", actualizarSumaFracciones);

          fila.appendChild(etiqueta);
          fila.appendChild(entrada);
          contenedor.appendChild(fila);

          entradasComposicion[clave] = entrada;
        }
        actualizarSumaFracciones();
      }

      function manejarEventoTeclado(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "v") {
          e.preventDefault();
          procesarPegado();
        }
      }

      function procesarPegado() {
        if (!navigator.clipboard) return;
        navigator.clipboard
          .readText()
          .then((text) => {
            const textoSaneado = text.replace(/,/g, ".");
            const valores = textoSaneado.trim().split(/\s+/);
            let indice = 0;
            for (const clave in entradasComposicion) {
              if (indice < valores.length) {
                const numero = parseFloat(valores[indice]);
                entradasComposicion[clave].value = !isNaN(numero) ? numero : "";
                indice++;
              }
            }
            actualizarSumaFracciones();
          })
          .catch((err) => console.error(err));
      }

      function actualizarSumaFracciones() {
        let suma = 0;
        for (const entrada of Object.values(entradasComposicion)) {
          suma += parseFloat(entrada.value) || 0;
        }
        document.getElementById("sumValue").textContent = suma.toFixed(4);
        const valDiv = document.getElementById("sumValidation");
        valDiv.innerHTML = `<span data-i18n="val_sum">${translations[currentLang]["val_sum"]}</span><span id="sumValue">${suma.toFixed(4)}</span>`;

        if (Math.abs(suma - 1) < 0.001) {
          valDiv.className = "sum-validation sum-valid";
        } else {
          valDiv.className = "sum-validation sum-invalid";
        }
      }

      function updatePipeDimensions() {
        const pipeSize = document.getElementById("pipeSize").value;
        const scheduleSelect = document.getElementById("schedule");
        const odField = document.getElementById("outsideDiameter");

        scheduleSelect.innerHTML = `<option value="">${translations[currentLang]["sel_sch"]}</option>`;

        if (pipeSize && pipeDimensions[pipeSize]) {
          const pipe = pipeDimensions[pipeSize];
          odField.value = pipe.OD.toFixed(3);

          // Ordenar schedules lógicamente: numéricos primero, luego letras
          const schedules = Object.keys(pipe.schedules).sort((a, b) => {
            const isANum = !isNaN(a);
            const isBNum = !isNaN(b);
            if (isANum && isBNum) return parseFloat(a) - parseFloat(b);
            if (isANum) return -1;
            if (isBNum) return 1;
            return a.localeCompare(b);
          });

          schedules.forEach((sch) => {
            const option = document.createElement("option");
            option.value = sch;
            option.textContent = sch;
            scheduleSelect.appendChild(option);
          });
          scheduleSelect.disabled = false;
        } else {
          odField.value = "";
          scheduleSelect.disabled = true;
        }
        updateWallThickness();
      }

      function updateWallThickness() {
        const pipeSize = document.getElementById("pipeSize").value;
        const schedule = document.getElementById("schedule").value;

        if (
          pipeSize &&
          schedule &&
          pipeDimensions[pipeSize]?.schedules[schedule]
        ) {
          const wall = pipeDimensions[pipeSize].schedules[schedule];
          const od = parseFloat(
            document.getElementById("outsideDiameter").value,
          );
          document.getElementById("wallThickness").value = wall.toFixed(3);
          document.getElementById("insideDiameter").value = (
            od -
            2 * wall
          ).toFixed(3);
        } else {
          document.getElementById("wallThickness").value = "";
          document.getElementById("insideDiameter").value = "";
        }
      }

      function calcularPropiedadesPseudocriticas(fracciones) {
        let Psc = 0,
          Tsc = 0;
        for (const [gas, fraccion] of Object.entries(fracciones)) {
          if (gasProperties[gas]) {
            Psc += fraccion * gasProperties[gas].Pc;
            Tsc += fraccion * gasProperties[gas].Tc;
          }
        }
        return { Psc, Tsc };
      }

      function aplicarCorreccionWichertAziz(Psc, Tsc, yCO2, yH2S) {
        const A = yH2S + yCO2;
        const B = yH2S;
        const epsilon =
          120 * (Math.pow(A, 0.9) - Math.pow(A, 1.6)) +
          15 * (Math.pow(B, 0.5) - Math.pow(B, 4.0));
        const Tsc_corr = Tsc - epsilon;
        const Psc_corr = (Psc * Tsc_corr) / (Tsc + B * (1 - B) * epsilon);
        return { Psc_corr, Tsc_corr };
      }

      function calcularZ_DranchukAboukassem(Pr, Tr) {
        const A1 = 0.3265,
          A2 = -1.07,
          A3 = -0.5339,
          A4 = 0.01569,
          A5 = -0.05165,
          A6 = 0.5475,
          A7 = -0.7361,
          A8 = 0.1844,
          A9 = 0.1056,
          A10 = 0.6134,
          A11 = 0.721;
        const equation = (Z) => {
          const rho_r = (0.27 * Pr) / (Z * Tr);
          const t1 =
            A1 +
            A2 / Tr +
            A3 / Math.pow(Tr, 3) +
            A4 / Math.pow(Tr, 4) +
            A5 / Math.pow(Tr, 5);
          const t3 = A6 + A7 / Tr + A8 / Math.pow(Tr, 2);
          const t4 = A9 * (A7 / Tr + A8 / Math.pow(Tr, 2));
          const t5 =
            A10 *
            (1 + A11 * Math.pow(rho_r, 2)) *
            (Math.pow(rho_r, 2) / Math.pow(Tr, 3)) *
            Math.exp(-A11 * Math.pow(rho_r, 2));
          return (
            Z -
            (1 +
              t1 * rho_r +
              t3 * Math.pow(rho_r, 2) -
              t4 * Math.pow(rho_r, 5) +
              t5)
          );
        };

        let Z = 0.9,
          delta = 1;
        for (let i = 0; i < 100 && Math.abs(delta) > 1e-8; i++) {
          const h = 0.0001;
          const f = equation(Z);
          const f_prime = (equation(Z + h) - equation(Z - h)) / (2 * h);
          if (Math.abs(f_prime) < 1e-10) break;
          delta = f / f_prime;
          Z -= delta;
          if (Z < 0.2) Z = 0.2;
          if (Z > 2.0) Z = 2.0;
        }
        return Z;
      }

      function calcular() {
        try {
          const fracciones = {};
          let suma = 0;
          for (const [gas, entrada] of Object.entries(entradasComposicion)) {
            const v = parseFloat(entrada.value) || 0;
            fracciones[gas] = v;
            suma += v;
          }
          if (Math.abs(suma - 1) > 0.001) {
            alert(translations[currentLang]["alert_sum"] + suma.toFixed(4));
            return;
          }

          const P_op = parseFloat(
            document.getElementById("presionOperacion").value,
          );
          const T_op = parseFloat(
            document.getElementById("temperaturaOperacion").value,
          );
          const flujo = parseFloat(document.getElementById("flujoGas").value);
          const OD = parseFloat(
            document.getElementById("outsideDiameter").value,
          );
          const espesor = parseFloat(
            document.getElementById("wallThickness").value,
          );
          const P_atm =
            parseFloat(document.getElementById("presionAtmosferica").value) ||
            14.65;
          const C_custom = parseFloat(
            document.getElementById("constanteC").value,
          );

          if ([P_op, T_op, flujo, OD, espesor].some(isNaN)) {
            alert(translations[currentLang]["alert_req"]);
            return;
          }
          if (espesor >= OD / 2) {
            alert(translations[currentLang]["alert_thick"]);
            return;
          }

          const PM = Object.entries(fracciones).reduce(
            (s, [g, f]) => s + f * (gasProperties[g]?.MW || 0),
            0,
          );
          const G = PM / PM_AIRE;

          let { Psc, Tsc } = calcularPropiedadesPseudocriticas(fracciones);
          const yCO2 = fracciones.CO2 || 0,
            yH2S = fracciones.H2S || 0;

          if (yCO2 + yH2S > 0) {
            const corr = aplicarCorreccionWichertAziz(Psc, Tsc, yCO2, yH2S);
            Psc = corr.Psc_corr;
            Tsc = corr.Tsc_corr;
          }

          const P_abs = P_op + P_atm;
          const T_abs = T_op + 459.67;
          const Pr = P_abs / Psc;
          const Tr = T_abs / Tsc;

          let Z = 0.99;
          try {
            Z = calcularZ_DranchukAboukassem(Pr, Tr);
          } catch (e) {
            console.warn("Error Z calc");
          }

          const densidad = (PM * P_abs) / (Z * R_UNIVERSAL_IMPERIAL * T_abs);
          const flujo_scfm = (flujo * 1e6) / 1440;
          const flujo_acfm =
            flujo_scfm *
            (T_abs / TEMPERATURA_ESTANDAR) *
            (PRESION_ESTANDAR / P_abs) *
            Z;
          const ID_ft = (OD - 2 * espesor) / 12;
          const area = Math.PI * Math.pow(ID_ft / 2, 2);
          const velocidad = flujo_acfm / 60 / area;

          mostrarResultados(
            PM,
            G,
            Z,
            densidad,
            flujo_acfm,
            velocidad,
            C_custom,
          );
        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      function mostrarResultados(PM, G, Z, densidad, flow, vel, C_cust) {
        document.getElementById("resultPM").textContent = PM.toFixed(4);
        document.getElementById("resultGE").textContent = G.toFixed(4);
        document.getElementById("resultZ").textContent = Z.toFixed(4);
        document.getElementById("resultDensidad").textContent =
          densidad.toFixed(4);
        document.getElementById("resultACFM").textContent = flow.toFixed(2);
        document.getElementById("resultVelocidad").textContent = vel.toFixed(2);

        const tabla = document.getElementById("tablaResultados");
        tabla.innerHTML = "";

        const constantes = [100, 125, 150, 200, 250];
        if (C_cust) constantes.push(C_cust);
        const constantesUnicas = [...new Set(constantes)].sort((a, b) => a - b);

        constantesUnicas.forEach((C) => {
          const v_erosional = C / Math.sqrt(densidad);
          const pct = (vel / v_erosional) * 100;
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${C}${C === C_cust ? "*" : ""}</td>
                    <td>${vel.toFixed(2)}</td>
                    <td>${v_erosional.toFixed(2)}</td>
                    <td style="color:${pct > 100 ? "#c62828" : pct > 50 ? "#f57f17" : "#2e7d32"}; font-weight:bold;">
                        ${pct.toFixed(1)}%
                    </td>
                `;
          tabla.appendChild(tr);
        });
        document.getElementById("resultModal").style.display = "block";
      }

      function cerrarModal() {
        document.getElementById("resultModal").style.display = "none";
      }
      function limpiarCampos() {
        location.reload();
      }
      window.onclick = function (e) {
        if (e.target === document.getElementById("resultModal")) cerrarModal();
      };
    </script>
  </body>
</html>
